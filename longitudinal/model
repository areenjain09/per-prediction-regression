# 03_fit_model.R

library(glmmTMB)
library(MuMIn)

# Load data and model setup
data_clean <- readRDS("data_clean.rds")
model_setup <- readRDS("model_setup.rds")
formula_beta <- model_setup$formula_beta

# Fit beta mixed model
fit_beta <- glmmTMB(formula_beta, data = data_clean, family = beta_family(), na.action = na.omit)

# Model summary
print(summary(fit_beta))
print(VarCorr(fit_beta))
cat("AIC:", AIC(fit_beta), "\n")
cat("BIC:", BIC(fit_beta), "\n")

# Compare with null model
null_model <- glmmTMB(as.formula(paste("PER_beta ~ 1 + (1 | Player)")), data = data_clean, family = beta_family())
print(anova(null_model, fit_beta))

# Predictions
data_clean$predicted_PER_beta <- predict(fit_beta, type = "response")
data_clean$predicted_PER_beta_pop <- predict(fit_beta, type = "response", re.form = NA)

# Save model and predictions for next script
saveRDS(list(fit_beta = fit_beta, data_clean = data_clean), "model_fit.rds")
